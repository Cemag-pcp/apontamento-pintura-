{% extends "index.html" %}
{% block body %}

<form action="/" onsubmit="mostrarLoadingOverlay();" method="POST">
    <div class="form-group">
        <label>Data:</label>
            <input name = "filtro_data" type="date" onchange=" mostrarLoadingOverlay(); this.form.elements['filtro_cor'].value = 'Todas'; this.form.submit();" value="{{ request.form['filtro_data'] }}">
        <label>Cores:</label>
        <select name = 'filtro_cor'>
            <option value="Todas" {% if request.form['filtro_cor'] == 'Todas' %} selected {% endif %}>Todas</option>
            {% for cor in cores %}
            <option value="{{ cor }}" {% if request.form['filtro_cor'] == cor %} selected {% endif %}>{{ cor }}</option>
            {% endfor %}
        </select>
        <button id="filtrar-button" type="submit">Filtrar</button>
    </div>
</form>

<h1 id = 'titulo_gerar'>Gerar Cambão</h1>
<div id="planilha">
    <div class="center-container">
        <table class="table table-striped centered-table">       
        <thead id = 'cabecalho_gerar'>
            <tr style="margin-bottom: 20px;">
                <th>Data</th>
                <th>Código</th>
                <th>Descrição</th>
                <th>Quant. Itens</th>
                <th>Cor</th>
                <th>Prod.</th>
                <th>Cambão</th>
                <th>Tipo</th>
            </tr>
        </thead>
        <tbody>
            {% if sheet_data %}
                {% for data in sheet_data %}
                <tr>
                    <td><input id = 'data' type="text" value="{{ data[0] }}" disabled></td>
                    <td><input id = 'codigo' type="text" value="{{ data[1] }}" disabled></td>
                    <td><input id = 'descricao' type="text" value="{{ data[2] }}" disabled></td>
                    <td><input id = 'qt_itens' type="text" value="{{ data[3] }}" disabled></td>
                    <td><input id = 'cor' type="text" value="{{ data[4] }}" disabled></td>
                    <td><input id = 'prod' type="text" value="{{ data[5] }}"></td>
                    <td><input id = 'cambao' type="text" value="{{ data[6] }}"></td>
                    <td>
                        <select id = 'tipo' type="text" value="{{ data[7] }}">
                            <option value="" selected hidden></option>
                            <option value="PO">PO</option>
                            <option value="PU">PU</option>
                        </select>
                    </td>
                </tr>
                {% endfor %}

            {% else %}
                <tr>
                    <td colspan="7">Nenhum dado disponível</td>
                </tr>
            {% endif %}
        </tbody>
        </table>
    </div>
</div>
<button class="botao-enviar-tabela-1">Enviar</button>

<div id="loading-overlay" style="display: none;">
    <div id="loading-spinner"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('.botao-enviar-tabela-1').click(function() {
            $("#loading-overlay").show();
            var dados = [];

            $('#planilha tbody tr').each(function() {
                var data = $(this).find('#data').val();
                var codigo = $(this).find('#codigo').val();
                var descricao = $(this).find('#descricao').val();
                var qt_itens = $(this).find('#qt_itens').val();
                var cor = $(this).find('#cor').val();
                var prod = $(this).find('#prod').val();
                var cambao = $(this).find('#cambao').val();
                var tipo = $(this).find('#tipo').val();

                dados.push({
                    data: data,
                    codigo: codigo,
                    descricao: descricao,
                    qt_itens: qt_itens,
                    cor: cor,
                    prod: prod,
                    cambao: cambao,
                    tipo: tipo,
                });
            });

            $.ajax({
                type: 'POST',
                url: '/send_gerar',
                data: JSON.stringify(dados),
                contentType: 'application/json',
                complete: function() {
                    // Ocultar o indicador de carregamento
                    location.reload();
                }
            });
        });
                    $("#loading-overlay").hide();
    });
</script>

{% endblock %}